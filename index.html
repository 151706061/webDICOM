<!DOCTYPE html>
<html>
    <head>
        <title>webDICOM</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

        <!--CSS-->
        <link rel="stylesheet" href="css/main.css">
        <link rel="stylesheet" href="css/jquery-ui-1.10.2.custom.css">

        <!-- jQuery -->
        <script type="text/javascript" src="js/libs/jquery-1.9.1/jquery.min.js"></script>
        <script type="text/javascript" src="js/libs/jquery-ui-1.10.2/jquery-ui.custom.min.js"></script>
        <script type="text/javascript" src="js/libs/jquery.tree.js"></script>
        <!--<script type="text/javascript" src="js/libs/jsTree-2.0.0/jstree.min.js"></script>-->

        <!-- External jsdicom-lib -->
        <script type="text/javascript" src="js/libs/jsdicom-lib/src/dcmdict.js"></script>
        <script type="text/javascript" src="js/libs/jsdicom-lib/src/binutils.js"></script>
        <script type="text/javascript" src="js/libs/jsdicom-lib/src/dcmfile.js"></script>
        <script type="text/javascript" src="js/libs/jsdicom-lib/src/dicomparser.js"></script>
        <script type="text/javascript" src="js/libs/jsdicom-lib/src/transfersyntax.js"></script>
        <script type="text/javascript" src="js/libs/jsdicom-lib/src/qr.js"></script>

        <!--Dicom Viewer-->
        <script type="text/javascript" src="js/DcmViewer.js"></script>
        <script type="text/javascript" src="js/DcmParser.js"></script>
        <script type="text/javascript" src="js/CanvasPainter.js"></script>
        <script type="text/javascript" src="js/Toolbox.js"></script>

        <!-- Tools -->
        <script type="text/javascript" src="js/tools/WindowLevel.js"></script>
        <script type="text/javascript" src="js/tools/Zoom.js"></script>
        <script type="text/javascript" src="js/tools/Move.js"></script>

        <script>
            $(document).ready(function() {
                var dcmViewer = new DcmViewer('myCanvas');
                var dcmParser = new DcmParser();
//                $('#dicomUpload').change(function(e) {
//                    dcmViewer.loadFiles(e.target.files);
//                    console.log(e.target.files);
//                    if(dcmViewer.numFiles > 1) {
//                        $("#slider").slider({
//                            value: 0,
//                            min: 0,
//                            max: dcmViewer.numFiles - 1,
//                            step: 1,
//                            slide: function(e, ui) {
//                                dcmViewer.scrollOne(ui.value);
//                            }
//                        });
//                    } else {
//                        if($("#slider").slider()) {
//                            $("#slider").slider("destroy");
//                        }
//                    }
//                });

                $('#buttonSet').change(function() {
                    dcmViewer.setCurrentTool($("input[name='toolbox-buttons']:checked").val());
                });
                $('#resetButton').click(function() {
                    if(dcmViewer.eventsEnabled) {
                        dcmViewer.painter.reset();
                    }
                });
                $('#myCanvas').click(function(e) {
                    dcmViewer.eventHandler(e);
                });
                $('#myCanvas').mousemove(function(e) {
                    dcmViewer.eventHandler(e);
                });
                $('#myCanvas').mousedown(function(e) {
                    dcmViewer.eventHandler(e);
                });
                $('#myCanvas').mouseup(function(e) {
                    dcmViewer.eventHandler(e);
                });
                $('#myCanvas').mouseout(function(e) {
                    dcmViewer.eventHandler(e);
                });
                $('#myCanvas').bind('mousewheel', function(e) {
                    if(dcmViewer.numFiles > 1) {
                        e.preventDefault();
                        var num = dcmViewer.scrollHandler(e);
                        $('#slider').slider('value', num);
                    }
                });
                // scroll event for firefox
                $('#myCanvas').bind('DOMMouseScroll', function(e) {
                    if(dcmViewer.numFiles > 1) {
                        e.preventDefault();
                        var num = dcmViewer.scrollHandler(e);
                        $('#slider').slider('value', num);
                    }
                });
                $('#buttonSet').buttonset();
                $('#resetButton').button();
//               
                function Tree(selector) {
                    this.$el = $(selector);
                    this.fileList = [];
                    var html_ = [];
                    var dcmTree = {};
                    var dcmList = [];
                    this.parsedFileList = [];
                    var self = this;

                    this.dcmRender = function(tree) {
                        if(tree) {
                            for(var object in tree) {
                                if($.isArray(tree[object])) { // series have an array - patients a object
                                    html_.push('<li><a href="#" data-type="file" data-index="' + tree[object] + '" >', object, '</a></li>');
                                } else {
                                    html_.push('<li><a href="#" data-type="folder">', object, '</a>');
                                    html_.push('<ul>');
                                    self.dcmRender(tree[object]);
                                    html_.push('</ul>');
                                }
                            }

                            $('#fileTree').html(html_.join(''));
//                                    .tree({
//                                expanded: 'li:first'
//                            });
                        }
                    };

                    this.buildFromDcmList = function(files) {
                        for(var i = 0; i < files.length; i++) {
                            var file = files[i];

                            if(!dcmTree[file.PatientsName]) {
                                dcmTree[file.PatientsName] = {};
                                dcmTree[file.PatientsName][file.SeriesDescription] = [];
                                dcmTree[file.PatientsName][file.SeriesDescription].push(i);
                            } else {
                                if(!dcmTree[file.PatientsName][file.SeriesDescription]) {
                                    dcmTree[file.PatientsName][file.SeriesDescription] = [];
                                    dcmTree[file.PatientsName][file.SeriesDescription].push(i);
                                } else {
                                    dcmTree[file.PatientsName][file.SeriesDescription].push(i);
                                }
                            }
                        }
                        return dcmTree;
                    };

                    this.init = function(e) {
                        html_ = [];
                        tree_ = {};
                        dcmTree = {};
                        pathList_ = [];
                        dcmList = [];
                        self.parsedFileList = [];
                        self.fileList = e.target.files;
                        // TODO: optimize this so we're not going through the file list twice (here and in buildFromPathList).
                        for(var i = 0; i < self.fileList.length; i++) {
                            if(self.fileList[i].type === "application/dicom") {
                                dcmList.push(self.fileList[i]);
                            }

                        }

                        dcmParser.parseFiles(dcmList, function(e) {
                            self.parsedFileList = e; 
                            self.dcmRender(self.buildFromDcmList(self.parsedFileList));
                        });

                        $("#slider").slider({
                            value: 0,
                            min: 0,
                            max: dcmViewer.numFiles - 1,
                            step: 1,
                            slide: function(e, ui) {
                                dcmViewer.scrollOne(ui.value);
                            }
                        });
//                        self.render(self.buildFromPathList(pathList_));
//                        console.log(tree_);
//                        console.log(self.buildFromFileList(dcmList));
//                        self.$el.html(html_.join(''));
//                                .tree({
//                            expanded: 'li:first'
//                        });
                    };
                }
                ;

                var tree = new Tree('#fileTree');
                $('#dicomUpload').change(tree.init);

                tree.$el.click(function(e) {
                    console.log(e.target.dataset.index);
                    if(e.target.nodeName === 'A' && e.target.dataset['type'] === 'file') {
                        var serie = [];
                        for(var i = 0; i < e.target.dataset.index.length; i++) {
                            // TODO: parse Array from String
                            console.log(e.target.dataset.index[i]);
                            serie.push(tree.parsedFileList[e.target.dataset.index[i]]);
                        }
                        dcmViewer.painter.setSeries(serie);
                        dcmViewer.painter.drawImg();
                        //var file = tree.fileList[e.target.dataset['index']];
                        //dcmViewer.loadFiles([file], function() {
                        //});
                    }
                });
            });
        </script>
    </head>
    <body>
        <div id="container">
            <aside id="sidebar">
                <!--<input id="dicomUpload" type="file" accept="application/dicom" multiple />--> 
                <!--Only Chrome supports webkitdirectory-->
                <input id="dicomUpload" type="file" multiple webkitdirectory directory />

                <progress value="0.5"></progress> 

                <div id="fileTree"></div>
            </aside>
            <div id="viewer">
                <div id="toolbox">
                    <span id="buttonSet">
                        <input type="radio" id="windowLevel" name="toolbox-buttons" value="Window level" checked="checked" /><label for="windowLevel">Window level</label>
                        <input type="radio" id="move" name="toolbox-buttons" value="Move" /><label for="move">Move</label>
                        <input type="radio" id="zoom" name="toolbox-buttons" value="Zoom" /><label for="zoom">Zoom</label>
                    </span>
                    <button type="button" class="ui-button-text" id="resetButton" value="Reset">Reset</button>
                </div>

                <canvas id="myCanvas" width="512" height="512">Your browser doesn't support HTML5</canvas>
                <div id="slider"></div>
            </div>
        </div>
    </body>
</html>
